<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SARTORIAL | å°ˆå±¬æ™ºæ…§è¡£æ«¥</title>
    <style>
        /* =========================================
           CSS è®Šæ•¸èˆ‡è¨­è¨ˆç³»çµ± (UI Theme System)
           ========================================= */
        :root {
            /* é è¨­ä¸»é¡Œï¼šæŸ”å’Œæœ¨è³ªèª¿ (Misty Beige) */
            --primary-color: #8E8070;       /* è«è˜­è¿ªæ£• */
            --bg-color: #F9F8F6;            /* æº«æš–ç±³ç™½ */
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-main: #4A4A4A;
            --text-sub: #908E8C;
            --border: #ECEBE9;
            --radius: 8px;
            --font-size-base: 16px;
            --shadow: 0 10px 40px rgba(120, 110, 100, 0.05);
            --font-main: "Helvetica Neue", "PingFang TC", "Heiti TC", "Microsoft JhengHei", sans-serif;
            --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            --backdrop: blur(12px);
        }

        /* ä¸»é¡Œè‰²å®šç¾© */
        [data-theme="misty-beige"] { --primary-color: #8E8070; --bg-color: #F9F8F6; --card-bg: rgba(255, 255, 255, 0.9); }
        [data-theme="forest-green"] { --primary-color: #6B8E6B; --bg-color: #F1F5F1; --card-bg: rgba(255, 255, 255, 0.95); }
        [data-theme="soft-pink"] { --primary-color: #B08B95; --bg-color: #FCF5F6; --card-bg: rgba(255, 255, 255, 0.9); }
        [data-theme="classic-navy"] { --primary-color: #5C6B7F; --bg-color: #F0F2F5; --card-bg: rgba(255, 255, 255, 0.95); --text-main: #2C3E50; }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            font-size: var(--font-size-base);
            margin: 0; padding: 0;
            line-height: 1.6;
            font-weight: 300;
            letter-spacing: 0.05em;
            overflow-x: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }

        /* =========================================
           1. åŸºç¤ UI å…ƒä»¶
           ========================================= */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease, transform 1s ease;
        }
        .intro-content { z-index: 2; text-align: center; animation: fadeIn 2s ease; }
        .intro-logo { font-size: 3rem; letter-spacing: 0.3em; margin-bottom: 10px; color: var(--primary-color); }
        .intro-sub { font-size: 1rem; color: #999; letter-spacing: 0.1em; margin-bottom: 40px; }
        .intro-input {
            border: none; border-bottom: 1px solid #CCC; background: transparent;
            font-size: 1.2rem; text-align: center; padding: 10px; margin-top: 20px;
            color: #555; width: 250px;
        }
        .intro-btn {
            margin-top: 40px; padding: 12px 40px; border: 1px solid var(--primary-color);
            background: transparent; color: var(--primary-color); border-radius: 30px; cursor: pointer;
            transition: var(--transition);
        }
        .intro-btn:hover { background: var(--primary-color); color: #FFF; }

        #app-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 70px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px; z-index: 100;
            background: rgba(255,255,255,0.7); backdrop-filter: var(--backdrop);
        }
        .hamburger { font-size: 1rem; cursor: pointer; color: var(--text-main); letter-spacing: 0.2em; }
        .app-title { font-size: 1.1rem; letter-spacing: 0.2em; font-weight: 400; }

        #drawer {
            position: fixed; top: 0; left: 0; width: 300px; height: 100%;
            background: #FFF; box-shadow: 10px 0 40px rgba(0,0,0,0.03);
            transform: translateX(-100%); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 200; display: flex; flex-direction: column; padding: 100px 40px 40px;
        }
        #drawer.open { transform: translateX(0); }
        
        .drawer-info { margin-bottom: 50px; }
        .drawer-date { font-size: 0.8rem; color: var(--text-sub); letter-spacing: 0.1em; }
        .drawer-weather { font-size: 0.9rem; margin-top: 5px; color: var(--text-main); }
        .drawer-quote { font-size: 0.85rem; font-style: italic; margin-top: 20px; line-height: 1.6; color: var(--primary-color); border-left: 2px solid #EEE; padding-left: 15px; }
        
        .nav-item {
            padding: 15px 0; font-size: 1rem; cursor: pointer; color: #888;
            transition: 0.3s; border-bottom: 1px solid transparent; letter-spacing: 0.05em;
        }
        .nav-item:hover { color: var(--text-main); padding-left: 10px; }

        #drawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.5); backdrop-filter: blur(3px); z-index: 150;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        #drawer-overlay.open { opacity: 1; pointer-events: auto; }

        main {
            padding-top: 90px; padding-bottom: 60px;
            max-width: 900px; margin: 0 auto; min-height: 100vh;
        }

        .section { display: none; animation: fadeInPage 0.8s ease; padding: 0 20px; }
        .section.active { display: block; }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--card-bg); border-radius: var(--radius);
            box-shadow: var(--shadow); padding: 35px; margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.6); transition: var(--transition);
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 20px 50px rgba(0,0,0,0.06); }

        .btn {
            border: none; cursor: pointer; border-radius: 4px; padding: 12px 28px;
            font-size: 0.95rem; transition: var(--transition); letter-spacing: 0.1em;
            display: inline-flex; align-items: center; justify-content: center;
            font-family: var(--font-main);
        }
        .btn-primary { background-color: var(--text-main); color: #FFF; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .btn-text { background: transparent; padding: 5px 10px; color: var(--text-sub); border: none; font-size: 0.85rem; cursor: pointer; text-decoration: underline; }
        .btn-danger { background: transparent; color: #cc0000; border: 1px solid #cc0000; }
        .btn-danger:hover { background: #cc0000; color: white; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-pill {
            display: inline-block; padding: 8px 16px; background: #FFF;
            border-radius: 20px; font-size: 0.85rem; color: var(--text-sub);
            cursor: pointer; border: 1px solid #EEE; transition: 0.2s;
            user-select: none; margin: 0;
        }
        .tag-pill:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .tag-pill.active {
            background: var(--primary-color); color: white; border-color: var(--primary-color);
            box-shadow: 0 5px 15px rgba(142, 128, 112, 0.2);
        }

        .input-field {
            width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid #DDD;
            background: transparent; margin-bottom: 20px; font-family: var(--font-main);
            color: var(--text-main); font-size: 1rem; transition: 0.3s; border-radius: 0;
        }
        .input-field:focus { border-bottom-color: var(--primary-color); }

        /* =========================================
           2. HOME - Hero & Weather
           ========================================= */
        .home-hero { display: flex; justify-content: center; align-items: center; padding: 20px 0 20px; }
        .hero-card.glass {
            position: relative; width: 100%; padding: 40px 32px 50px;
            border-radius: 28px; background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.7), rgba(255, 240, 245, 0.85));
            box-shadow: 0 18px 45px rgba(180, 150, 160, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(22px); -webkit-backdrop-filter: blur(22px); overflow: hidden;
            opacity: 0; transform: translateY(10px); animation: heroFadeIn 0.7s ease-out forwards;
        }
        .hero-card.glass .hero-header { animation: heroFadeIn 0.7s ease-out forwards 0.05s; opacity: 0; }
        .hero-card.glass .hero-note { animation: heroFadeIn 0.7s ease-out forwards 0.12s; opacity: 0; }
        .hero-card.glass .hero-actions { animation: heroFadeIn 0.7s ease-out forwards 0.18s; opacity: 0; }
        @keyframes heroFadeIn { to { opacity: 1; transform: translateY(0); } }

        .brand-title-animated { font-size: 1.2rem; letter-spacing: 0.16em; margin-bottom: 30px; text-align: center; color: var(--primary-color); animation: titleFloat 4s ease-in-out infinite; display: block; }
        @keyframes titleFloat { 0%, 100% { letter-spacing: 0.16em; transform: translateY(0); } 50% { letter-spacing: 0.22em; transform: translateY(-1px); } }

        .hero-header { text-align: center; margin-bottom: 30px; position: relative; z-index: 2; }
        .hero-date { font-size: 0.9rem; letter-spacing: 0.2em; color: var(--text-sub); margin-bottom: 15px; }
        
        .hero-weather { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .weather-icon-wrapper { width: 72px; height: 72px; position: relative; }
        .weather-icon { width: 100%; height: 100%; position: relative; }
        .weather-text { text-align: left; }
        .weather-main { font-size: 1.8rem; font-weight: 300; color: var(--text-main); line-height: 1.2; }
        .weather-sub { font-size: 1rem; color: var(--text-sub); }

        .icon-sunny::before { content: ""; position: absolute; inset: 18px; border-radius: 50%; background: radial-gradient(circle, #ffe9b3, #ffcc7a); box-shadow: 0 0 18px rgba(255, 210, 130, 0.7); }
        .icon-sunny::after { content: ""; position: absolute; inset: 8px; border-radius: 50%; border: 1px solid rgba(255, 230, 180, 0.7); }
        .icon-rainy-light::before { content: ""; position: absolute; top: 15px; left: 10px; width: 50px; height: 30px; background: #E0E0E0; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .icon-rainy-light::after { content: ""; position: absolute; top: 50px; left: 25px; width: 2px; height: 10px; background: #AAA; box-shadow: 10px 5px 0 #AAA, -10px 8px 0 #AAA; }
        .icon-cloudy::before { content: ""; position: absolute; top: 20px; left: 15px; width: 45px; height: 25px; background: #DDD; border-radius: 20px; }
        .icon-cloudy::after { content: ""; position: absolute; top: 10px; left: 25px; width: 35px; height: 35px; background: #EEE; border-radius: 50%; z-index: -1; }

        .hero-note { margin: 30px 0; text-align: center; position: relative; z-index: 2; }
        .hero-note-label { font-size: 0.7rem; letter-spacing: 0.2em; color: var(--primary-color); margin-bottom: 8px; }
        .hero-note-text { font-size: 1.1rem; color: #555; font-style: italic; line-height: 1.6; }

        .hero-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; position: relative; z-index: 2; }
        .action-card { text-align: center; padding: 25px; cursor: pointer; border: 1px solid rgba(255,255,255,0.8); background: rgba(255,255,255,0.4); border-radius: var(--radius); transition: 0.3s; backdrop-filter: blur(5px); }
        .action-card:hover { background: #FFF; box-shadow: var(--shadow); transform: translateY(-2px); }
        .action-card h3 { margin: 0; font-size: 0.95rem; color: var(--text-main); letter-spacing: 0.05em; font-weight: 400; }

        .weather-animation { position: absolute; inset: -40%; pointer-events: none; z-index: 0; }
        .weather-animation.sunny::before, .weather-animation.sunny::after { content: ""; position: absolute; border-radius: 50%; background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent); filter: blur(10px); opacity: 0.7; animation: sunGlow 12s ease-in-out infinite alternate; }
        .weather-animation.sunny::before { width: 55%; height: 55%; top: -10%; right: -8%; }
        .weather-animation.sunny::after { width: 40%; height: 40%; bottom: -8%; left: -6%; }
        @keyframes sunGlow { 0% { transform: translate3d(0,0,0) scale(1); opacity: 0.55; } 100% { transform: translate3d(6px,-4px,0) scale(1.02); opacity: 0.6; } }
        .weather-animation.rainy { overflow: hidden; }
        .weather-animation.rainy::before { content: ""; position: absolute; inset: 0; background-image: repeating-linear-gradient(to bottom, rgba(180, 180, 200, 0.23), rgba(180, 180, 200, 0.23) 16px, transparent 16px, transparent 32px); opacity: 0.6; animation: rainFall 1.8s linear infinite; }
        @keyframes rainFall { 0% { transform: translateY(-20px); } 100% { transform: translateY(20px); } }
        .weather-animation.cloudy::before { content: ""; position: absolute; border-radius: 999px; background: radial-gradient(circle at 30% 30%, rgba(230, 230, 240, 0.85), transparent 60%); filter: blur(12px); opacity: 0.75; width: 130%; height: 70%; top: -15%; left: -10%; animation: fogFloat 16s ease-in-out infinite alternate; }
        @keyframes fogFloat { 0% { transform: translate3d(-6px, 2px, 0); opacity: 0.55; } 100% { transform: translate3d(2px, 4px, 0); opacity: 0.6; } }

        /* Today's Look Module */
        .glass-card-sm {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(142, 128, 112, 0.1);
            border-radius: var(--radius);
            padding: 30px 25px; margin-top: 35px;
            animation: slideUp 0.6s ease;
            position: relative; overflow: hidden;
            text-align: center;
        }
        .glass-card-sm::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8), transparent 70%);
            opacity: 0.4; pointer-events: none; z-index: 0;
        }
        .today-content { position: relative; z-index: 1; }
        .today-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .today-date-sm { font-size: 0.85rem; letter-spacing: 0.1em; color: var(--text-sub); }
        .today-weather-sm { font-size: 0.9rem; color: var(--text-main); font-weight: 400; display: flex; align-items: center; gap: 8px; }
        .today-items-row { display: flex; justify-content: center; gap: 15px; margin: 25px 0; }
        .today-thumb { width: 65px; height: 85px; border-radius: 4px; object-fit: cover; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: transform 0.3s; background: #FFF; }
        .today-thumb:hover { transform: translateY(-3px); }
        .today-btn-row { margin-top: 10px; }
        .today-meta { font-size: 0.85rem; color: #666; margin-top: 15px; border-top: 1px dashed #EEE; padding-top: 10px; text-align: left; }
        .today-meta p { margin: 5px 0; display: flex; justify-content: space-between; }
        .today-care-block { background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 10px; text-align: left; color: #555; }

        /* Feedback Modal (Full Screen) */
        .modal-fullscreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FAFAFA; z-index: 2000;
            display: none; flex-direction: column;
            overflow-y: auto; opacity: 0; transition: opacity 0.3s;
        }
        .modal-fullscreen.open { display: flex; opacity: 1; }
        .mf-header {
            padding: 20px 25px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #EEE;
        }
        .mf-title { font-size: 1rem; letter-spacing: 0.1em; color: var(--text-main); }
        .mf-close { font-size: 1.5rem; cursor: pointer; color: #999; }
        .mf-body { padding: 30px 20px 60px; max-width: 600px; margin: 0 auto; width: 100%; }
        .preview-section { margin-bottom: 40px; text-align: center; }
        .preview-imgs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .preview-img-lg { width: 90px; height: 120px; object-fit: cover; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .scent-info-card {
            background: #FFF; padding: 20px; border-radius: 8px; border: 1px solid #EEE;
            text-align: left; margin-top: 20px;
        }
        .scent-name { font-size: 1rem; color: var(--primary-color); margin-bottom: 5px; font-weight: 400; }
        .scent-family { font-size: 0.8rem; color: #999; margin-bottom: 15px; letter-spacing: 0.05em; text-transform: uppercase; }
        .scent-detail { display: flex; flex-direction: column; gap: 8px; font-size: 0.85rem; color: #555; }
        .scent-desc { margin-top: 15px; font-style: italic; color: #777; font-size: 0.9rem; border-top: 1px dashed #EEE; padding-top: 10px; }
        .seg-control { display: flex; background: #EEE; border-radius: 6px; padding: 4px; margin-bottom: 10px; }
        .seg-label { flex: 1; text-align: center; padding: 8px 0; font-size: 0.9rem; cursor: pointer; border-radius: 4px; color: #888; transition: 0.2s; }
        .seg-radio { display: none; }
        .seg-radio:checked + .seg-label { background: #FFF; color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 500; }
        .photo-upload-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .photo-slot {
            aspect-ratio: 1; background: #F0F0F0; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden; border: 1px dashed #CCC;
        }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; }
        .photo-slot span { font-size: 2rem; color: #DDD; }
        .photo-input { display: none; }

        /* =========================================
           Wardrobe & Others
           ========================================= */
        #add-btn-float { position: absolute; top: 20px; right: 20px; background: transparent; color: var(--text-main); border: 1px solid var(--border); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: 0.3s; }
        #add-btn-float:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .wardrobe-filters { display: flex; gap: 15px; margin-bottom: 30px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #EEE; }
        .filter-btn { cursor: pointer; color: var(--text-sub); font-size: 0.9rem; white-space: nowrap; padding-bottom: 10px; transition: 0.3s; }
        .filter-btn.active { color: var(--text-main); border-bottom: 2px solid var(--text-main); }
        .wardrobe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
        .w-item { position: relative; background: #FFF; border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: 0.3s; cursor: pointer; }
        .w-item:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .w-img { width: 100%; aspect-ratio: 3/4; object-fit: cover; background: #F5F5F5; }
        .w-info { padding: 12px; }
        .w-name { font-size: 0.85rem; font-weight: 500; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .w-tag { font-size: 0.75rem; color: #999; }
        .w-delete { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: rgba(255, 255, 255, 0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #cc0000; font-size: 14px; opacity: 0; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 5; }
        .w-item:hover .w-delete { opacity: 1; }
        .w-delete:hover { background: #cc0000; color: #FFF; transform: scale(1.1); }

        /* OOTD & Confirm Modal */
        .ootd-form { margin-bottom: 40px; }
        .outfit-card { border-left: 3px solid var(--primary-color); background: linear-gradient(to right, #FFFEFC, #FBFBFB); opacity: 0; transform: translateY(14px) scale(0.98); animation: outfitEnter 0.55s ease-out forwards; transition: transform 0.22s ease-out, box-shadow 0.22s ease-out; }
        .outfit-card:nth-child(1) { animation-delay: 0.0s; } .outfit-card:nth-child(2) { animation-delay: 0.07s; } .outfit-card:nth-child(3) { animation-delay: 0.14s; }
        .outfit-card:hover { transform: translateY(-4px) scale(1.01); box-shadow: 0 14px 32px rgba(140, 120, 130, 0.28); }
        @keyframes outfitEnter { to { opacity: 1; transform: translateY(0) scale(1); } }
        .ootd-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .ootd-display { display: flex; gap: 15px; overflow-x: auto; margin: 20px 0; padding-bottom: 10px; justify-content: flex-start; }
        .ootd-piece { text-align: center; min-width: 90px; }
        .ootd-piece img { width: 90px; height: 110px; border-radius: 4px; object-fit: cover; margin-bottom: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .ootd-piece span { font-size: 0.75rem; color: #888; }
        .scent-box { margin-top: 15px; padding: 12px; background: rgba(142, 128, 112, 0.08); border-radius: 4px; font-size: 0.85rem; color: #666; text-align: center; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px dashed #EEE; padding-bottom: 10px; }
        .toggle-label { font-size: 0.95rem; color: var(--text-main); }
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #DDD; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* History */
        .history-list { display: flex; flex-direction: column; gap: 30px; }
        .h-item { padding-bottom: 30px; border-bottom: 1px solid #EEE; display: grid; grid-template-columns: 80px 1fr; gap: 20px; }
        .h-date { font-size: 0.85rem; color: var(--text-sub); letter-spacing: 0.1em; }
        .h-weather { font-size: 1.1rem; color: var(--text-main); margin-top: 5px; }
        .h-imgs { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; align-items: center; }
        .h-imgs img { width: 50px; height: 65px; object-fit: cover; background: #EEE; border-radius: 2px; }
        .h-user-photo { border: 2px solid var(--primary-color); width: 60px !important; height: 80px !important; }
        .h-note { font-size: 0.9rem; color: #555; margin-bottom: 10px; line-height: 1.6; background: #FAFAFA; padding: 10px; border-radius: 4px; }
        .h-tags { font-size: 0.8rem; color: #999; display: flex; gap: 15px; flex-wrap: wrap; }
        .h-scent-tag { display: inline-flex; align-items: center; color: var(--primary-color); font-size: 0.8rem; margin-top: 5px; }
        .h-actions { margin-top: 10px; text-align: right; }

        /* Modal & Form */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.4s; }
        .modal.open { display: flex; opacity: 1; }
        .modal-content { background: #FFF; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 50px 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.08); position: relative; animation: slideUp 0.5s ease; border-radius: var(--radius); }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 25px; right: 25px; font-size: 1.5rem; cursor: pointer; color: #CCC; transition: 0.3s; }
        .close-modal:hover { color: #333; }
        .progress-dots { display: flex; justify-content: center; gap: 12px; margin-bottom: 40px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #EEE; transition: 0.3s; }
        .dot.active { background: var(--primary-color); transform: scale(1.3); }
        .step-view { display: none; }
        .step-view.active { display: block; animation: fadeIn 0.4s; }
        .outfit-preview-modal { opacity: 0; transform: scale(0.94) translateY(8px); animation: previewPop 0.32s cubic-bezier(0.16, 0.7, 0.25, 1) forwards; }
        @keyframes previewPop { 0% { opacity: 0; transform: scale(0.9) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .preview-grid { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; }
        .preview-item { text-align: center; width: 80px; }
        .preview-item img { width: 80px; height: 100px; object-fit: cover; margin-bottom: 5px; }
        .preview-item span { font-size: 0.7rem; color: #999; }
        .ai-text { font-size: 0.9rem; color: #666; line-height: 1.8; text-align: center; margin-bottom: 20px; padding: 0 20px; }
        textarea { width: 100%; border: 1px solid #EEE; padding: 15px; height: 100px; resize: none; margin-bottom: 20px; font-family: var(--font-main); }
        .form-group { margin-bottom: 30px; }
        .form-title { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 10px; display: block; letter-spacing: 0.1em; }
        .hint-text { font-size: 0.75rem; color: #AAA; margin-top: 5px; }
        .hidden { display: none !important; }

        /* Theme Swatch Styles */
        .theme-selector { display: flex; gap: 15px; margin-top: 10px; }
        .theme-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid #FFF; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s; position: relative; }
        .theme-swatch:hover { transform: scale(1.1); }
        .theme-swatch.active { transform: scale(1.15); box-shadow: 0 0 0 2px var(--primary-color), 0 4px 10px rgba(0,0,0,0.1); }
        .ts-soft { background: #B08B95; } .ts-moss { background: #6B8E6B; } .ts-warm { background: #8E8070; } .ts-mid { background: #5C6B7F; }
        .ts-label { position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; white-space: nowrap; color: var(--text-sub); opacity: 0; transition: 0.3s; }
        .theme-swatch:hover .ts-label { opacity: 1; bottom: -20px; }

        /* ğŸ”§ Item Detail Modal (New) */
        .detail-grid { display: grid; grid-template-columns: 1fr; gap: 20px; text-align: left; }
        .detail-img-box { width: 100%; height: 250px; background: #FAFAFA; display: flex; justify-content: center; align-items: center; border-radius: 8px; overflow: hidden; }
        .detail-img-box img { width: 100%; height: 100%; object-fit: contain; }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #EEE; padding: 12px 0; font-size: 0.9rem; }
        .detail-label { color: #999; font-size: 0.85rem; }
        .detail-val { color: var(--text-main); font-weight: 500; text-align: right; max-width: 60%; }
        .detail-tags { display: flex; flex-wrap: wrap; gap: 5px; justify-content: flex-end; }
        .detail-tag-sm { background: #F5F5F5; color: #666; font-size: 0.75rem; padding: 3px 8px; border-radius: 10px; }
        .detail-actions { margin-top: 30px; display: flex; justify-content: space-between; gap: 10px; }

        /* Care Info in OOTD */
        .care-info-box { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 10px; text-align: left; color: #666; line-height: 1.5; }

    </style>
</head>
<body>

    <!-- ğŸšª å…¥å ´ (è‹¥ç„¡ User) -->
    <div id="intro-overlay">
        <div class="intro-content">
            <div class="intro-logo">SARTORIAL</div>
            <div class="intro-sub">ç‚ºä½ æ‰“é€ å°ˆå±¬çš„æ™ºæ…§è¡£æ«¥</div>
            <input type="text" id="username-input" class="intro-input" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—">
            <br>
            <button class="intro-btn" onclick="initUser()">é€²å…¥æˆ‘çš„è¡£æ«¥</button>
        </div>
    </div>

    <!-- ğŸ” Header -->
    <header id="app-header">
        <div class="hamburger" onclick="toggleDrawer()">MENU</div>
        <div class="app-title">SARTORIAL</div>
        <div style="width: 40px;"></div>
    </header>

    <!-- ğŸ—„ Sidebar -->
    <div id="drawer-overlay" onclick="toggleDrawer()"></div>
    <nav id="drawer">
        <div class="drawer-header">
            <div id="drawer-date" class="drawer-date">--</div>
            <div id="drawer-weather" class="drawer-weather">Loading...</div>
            <div id="drawer-quote" class="drawer-quote"></div>
        </div>
        <div class="nav-item" onclick="navTo('home')" data-lang-key="menu_home">ä¸»é  Home</div>
        <div class="nav-item" onclick="navTo('ootd')" data-lang-key="menu_ootd">ä»Šæ—¥ç©¿æ­æ¨è–¦ OOTD</div>
        <div class="nav-item" onclick="navTo('history')" data-lang-key="menu_hist">æ­·å²ç©¿æ­ç´€éŒ„ History</div>
        <div class="nav-item" onclick="navTo('wardrobe')" data-lang-key="menu_ward">æˆ‘çš„è¡£æ«¥ Wardrobe</div>
        <div class="nav-item" onclick="navTo('pref')" data-lang-key="menu_pref">ç³»çµ±åå¥½è¨­å®š Preferences</div>
    </nav>

    <!-- ğŸ“± Main Content -->
    <main>

        <!-- ğŸ  HOME -->
        <section id="section-home" class="section active">
            <div class="home-hero">
                <div class="hero-card glass">
                    <div class="weather-animation" id="weather-anim-layer"></div>
                    <div class="hero-header">
                        <span class="brand-title-animated">SARTORIAL</span>
                        <div class="hero-date" id="home-date-display">--</div>
                        <div class="hero-weather">
                            <div class="weather-icon-wrapper"><div id="weather-icon-el" class="weather-icon"></div></div>
                            <div class="weather-text">
                                <div class="weather-main" id="home-weather-display">--</div>
                                <div class="weather-sub" id="home-greeting">Hi, User</div>
                            </div>
                        </div>
                    </div>
                    <div class="hero-note">
                        <div class="hero-note-label">DAILY NOTE</div>
                        <div class="hero-note-text" id="home-daily-note">Loading...</div>
                    </div>
                    <div class="hero-actions">
                        <div class="action-card" onclick="navTo('ootd')"><h3 data-lang-key="btn_ootd">å‰å¾€ä»Šæ—¥ç©¿æ­æ¨è–¦</h3></div>
                        <div class="action-card" onclick="navTo('wardrobe')"><h3 data-lang-key="btn_ward">æ•´ç†æˆ‘çš„è¡£æ«¥</h3></div>
                    </div>
                </div>
            </div>

            <!-- Today's Look Module -->
            <div id="home-today-card" style="display:none;">
                <div class="glass-card-sm">
                    <div class="today-content">
                        <div class="today-header-row">
                            <div class="today-date-sm" id="today-date-sm"></div>
                            <div class="today-weather-sm" id="today-weather-sm"></div>
                        </div>
                        <span class="today-label" style="font-size:0.9rem; letter-spacing:0.15em; color:var(--primary-color);">TODAY'S LOOK</span>
                        <div class="today-items-row" id="today-thumbnails"></div>
                        
                        <div class="today-meta">
                            <p><span>é¢¨æ ¼ï¼š</span><b id="today-meta-style" style="color:var(--primary-color)"></b></p>
                            <p><span>é¦™æ°›ï¼š</span><span id="today-meta-scent"></span></p>
                        </div>
                        <div id="today-care-block" class="today-care-block"></div>

                        <div class="today-btn-row">
                            <button class="btn btn-primary" onclick="openFeedbackPage()">å¡«å¯«ä»Šæ—¥ç©¿æ­ç´€éŒ„</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ğŸ‘š WARDROBE -->
        <section id="section-wardrobe" class="section">
            <div class="wardrobe-header">
                <div class="wardrobe-title" data-lang-key="menu_ward">Wardrobe</div>
                <button class="btn btn-outline" onclick="openAddModal()">ï¼‹ æ–°å¢å–®å“</button>
            </div>
            
            <div class="wardrobe-filters">
                <div class="filter-btn active" onclick="filterWardrobe('all', this)">å…¨éƒ¨</div>
                <div class="filter-btn" onclick="filterWardrobe('top', this)">ä¸Šè¡£</div>
                <div class="filter-btn" onclick="filterWardrobe('bottom', this)">ä¸‹è£</div>
                <div class="filter-btn" onclick="filterWardrobe('onepiece', this)">é€£è¡£è£™</div>
                <div class="filter-btn" onclick="filterWardrobe('outer', this)">å¤–å¥—</div>
                <div class="filter-btn" onclick="filterWardrobe('shoes', this)">é‹å­</div>
                <div class="filter-btn" onclick="filterWardrobe('acc', this)">é£¾å“</div>
            </div>

            <div class="wardrobe-grid" id="wardrobe-grid"></div>
        </section>

        <!-- ğŸ‘— OOTD -->
        <section id="section-ootd" class="section">
            <h2 style="margin-bottom:30px; font-weight:400; text-align:center;" data-lang-key="title_ootd">Today's Outfit</h2>
            <div class="card ootd-form">
                <div class="form-group">
                    <span class="form-title">ä»Šæ—¥æ°£æº« (Â°C)</span>
                    <input type="number" id="ootd-temp" class="input-field" value="24" onchange="updateWeatherAnim()">
                </div>
                <div class="form-group">
                    <span class="form-title">ä»Šæ—¥å ´æ™¯ (å¤šé¸)</span>
                    <div class="tags-container" id="ootd-scenes"></div>
                </div>
                <div class="form-group">
                    <span class="form-title">æƒ³å˜—è©¦çš„é¢¨æ ¼ (å¤šé¸)</span>
                    <div class="tags-container" id="ootd-styles"></div>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">æ˜¯å¦ä¸‹é›¨</span>
                    <label class="toggle-switch"><input type="checkbox" id="ootd-rain" onchange="updateWeatherAnim()"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">æ˜¯å¦éœ€è¦å¤–å¥—</span>
                    <label class="toggle-switch"><input type="checkbox" id="ootd-outer"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">æ˜¯å¦éœ€è¦é£¾å“</span>
                    <label class="toggle-switch"><input type="checkbox" id="ootd-acc" checked><span class="slider"></span></label>
                </div>
                <div style="margin-top:40px; text-align:center;">
                    <button class="btn btn-primary" onclick="generateOOTD()">ç”¢ç”Ÿæ¨è–¦</button>
                </div>
            </div>
            <div id="ootd-results"></div>
        </section>

        <!-- ğŸ“… HISTORY -->
        <section id="section-history" class="section">
            <h2 style="margin-bottom:30px; font-weight:400;" data-lang-key="title_hist">History</h2>
            <div class="history-list" id="history-list"></div>
        </section>

        <!-- âš™ï¸ PREFERENCES -->
        <section id="section-pref" class="section">
            <h2 style="margin-bottom:30px; font-weight:400;" data-lang-key="menu_pref">Preferences</h2>
            <div class="card">
                <div class="pref-group">
                    <span class="pref-title">ä»‹é¢è‰²ç³» Theme</span>
                    <div class="theme-selector">
                        <div class="theme-swatch ts-soft" onclick="previewTheme('soft-pink', this)" title="Soft Blush"><span class="ts-label">Soft Blush</span></div>
                        <div class="theme-swatch ts-moss" onclick="previewTheme('forest-green', this)" title="Moss Green"><span class="ts-label">Moss Green</span></div>
                        <div class="theme-swatch ts-warm" onclick="previewTheme('misty-beige', this)" title="Warm Beige"><span class="ts-label">Warm Beige</span></div>
                        <div class="theme-swatch ts-mid" onclick="previewTheme('classic-navy', this)" title="Midnight"><span class="ts-label">Midnight</span></div>
                    </div>
                </div>
                <div class="pref-group">
                    <span class="pref-title">èªè¨€ Language</span>
                    <select id="pref-lang" class="lang-select">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="pref-group">
                    <span class="pref-title">ä½¿ç”¨è€…åç¨±</span>
                    <input type="text" id="pref-name" class="input-field">
                </div>
                <div style="text-align:right; margin-top:30px;">
                    <button class="btn btn-primary" onclick="savePref()">å„²å­˜è¨­å®š</button>
                    <button class="btn btn-text" onclick="clearData()" style="color:#d9534f; margin-left:10px;">é‡ç½®è³‡æ–™</button>
                </div>
            </div>
        </section>

    </main>

    <!-- âœï¸ ADD ITEM MODAL -->
    <div id="modal-add" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('modal-add')">Ã—</span>
            <div class="progress-dots">
                <div class="dot active" id="dot-1"></div>
                <div class="dot" id="dot-2"></div>
                <div class="dot" id="dot-3"></div>
                <div class="dot" id="dot-4"></div>
            </div>
            <form id="add-form" onsubmit="return false;">
                <!-- STEP 1 -->
                <div id="step-1" class="step-view active">
                    <div class="form-group"><span class="form-title">å–®å“åç¨±</span><input type="text" id="inp-name" class="input-field" placeholder="Ex: ç±³è‰²ç¾Šæ¯›è¡«"></div>
                    <div class="form-group"><span class="form-title">é¡åˆ¥</span><select id="inp-category" class="input-field" onchange="updateStep2View()"><option value="top">ä¸Šè¡£ (Top)</option><option value="bottom">ä¸‹è£ (Bottom)</option><option value="onepiece">é€£è¡£è£™ (One-piece)</option><option value="outer">å¤–å¥— (Outer)</option><option value="shoes">é‹å­ (Shoes)</option><option value="acc">é£¾å“ (Accessory)</option></select></div>
                    <div class="form-group"><span class="form-title">åœ–ç‰‡ä¸Šå‚³</span><input type="file" id="inp-file" class="input-field" accept="image/*" onchange="previewImage(this)"><input type="hidden" id="inp-img-base64"></div>
                    <div style="text-align:right;"><button class="btn btn-primary" onclick="goStep(2)">ä¸‹ä¸€æ­¥</button></div>
                </div>
                <!-- STEP 2 -->
                <div id="step-2" class="step-view">
                    <div id="view-clothes" class="hidden">
                        <div class="form-group"><span class="form-title">é©åˆæ°£æº«</span><div class="tags-container" id="tags-temp"></div></div>
                        <div class="form-group"><span class="form-title">åšè–„åº¦</span><div class="tags-container" id="tags-thickness"></div></div>
                    </div>
                    <div id="view-shoes" class="hidden">
                        <div class="form-group"><span class="form-title">é‹æ¬¾é¡å‹</span><select id="inp-shoe-type" class="input-field"><option value="sneakers">çƒé‹ (Sneakers)</option><option value="boots">é´å­ (Boots)</option><option value="heels">é«˜è·Ÿé‹ (Heels)</option><option value="flats">å¹³åº•/æ¨‚ç¦é‹ (Flats)</option><option value="sandals">æ¶¼é‹ (Sandals)</option><option value="rainboots">é›¨é‹ (Rain Boots)</option></select></div>
                        <div class="form-group"><span class="form-title">åŠŸèƒ½å±¬æ€§ (å¦‚: é˜²æ°´)</span><div class="tags-container" id="tags-shoe-func"></div></div>
                        <div class="form-group"><span class="form-title">é‹åº•æ­¢æ»‘ç¨‹åº¦</span><select id="inp-shoe-grip" class="input-field"><option value="normal">æ™®é€š</option><option value="good">è‰¯å¥½</option><option value="excellent">æ¥µä½³(é˜²æ»‘)</option></select></div>
                    </div>
                    <div id="view-acc" class="hidden">
                        <div class="form-group"><span class="form-title">é£¾å“é¡å‹</span><select id="inp-acc-type" class="input-field"><option value="necklace">é …éŠ</option><option value="ring">æˆ’æŒ‡</option><option value="earrings">è€³ç’°</option><option value="bracelet">æ‰‹éŠ/æ‰‹ç’°</option><option value="hat">å¸½å­</option><option value="sunglasses">å¢¨é¡/çœ¼é¡</option><option value="scarf">åœå·¾/çµ²å·¾</option><option value="belt">çš®å¸¶</option></select></div>
                        <div class="form-group"><span class="form-title">é…æˆ´éƒ¨ä½</span><select id="inp-acc-part" class="input-field"><option value="head">é ­éƒ¨</option><option value="face">è‡‰éƒ¨</option><option value="ear">è€³æœµ</option><option value="neck">é ¸éƒ¨</option><option value="hand">æ‰‹/è…•/æŒ‡</option><option value="waist">è…°éƒ¨</option></select></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:20px;"><button class="btn btn-outline" onclick="goStep(1)">ä¸Šä¸€æ­¥</button><button class="btn btn-primary" onclick="goStep(3)">ä¸‹ä¸€æ­¥</button></div>
                </div>
                <!-- STEP 3 -->
                <div id="step-3" class="step-view">
                    <div class="form-group"><span class="form-title">æè³ª</span><div class="tags-container" id="tags-material"></div></div>
                    <div class="form-group"><span class="form-title">é¢¨æ ¼</span><div class="tags-container" id="tags-style"></div></div>
                    <div class="form-group"><span class="form-title">é©ç”¨å ´æ™¯</span><div class="tags-container" id="tags-scene"></div></div>
                    <div class="form-group"><span class="form-title">é¡è‰²</span><input type="text" id="inp-color" class="input-field" placeholder="Ex: é»‘è‰², å¡å…¶è‰²..."></div>
                    <div style="display:flex; justify-content:space-between; margin-top:20px;"><button class="btn btn-outline" onclick="goStep(2)">ä¸Šä¸€æ­¥</button><button class="btn btn-primary" onclick="goStep(4)">ä¸‹ä¸€æ­¥</button></div>
                </div>
                <!-- STEP 4 -->
                <div id="step-4" class="step-view">
                    <div class="form-group"><span class="form-title">ä¿é¤Š / æ´—æ»Œæ–¹å¼</span><div class="tags-container" id="tags-care"></div></div>
                    <div style="display:flex; justify-content:space-between; margin-top:20px;"><button class="btn btn-outline" onclick="goStep(3)">ä¸Šä¸€æ­¥</button><button class="btn btn-primary" onclick="saveItem()">å®Œæˆ</button></div>
                </div>
            </form>
        </div>
    </div>

    <!-- ğŸ”§ ITEM DETAIL MODAL (New) -->
    <div id="modal-item-detail" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('modal-item-detail')">Ã—</span>
            <div id="item-detail-content">
                <!-- JS will populate this -->
            </div>
        </div>
    </div>

    <!-- ğŸ”§ PREVIEW MODAL (OOTD Confirm) -->
    <div id="modal-confirm" class="modal">
        <div class="modal-content outfit-preview-modal">
            <span class="close-modal" onclick="closeModal('modal-confirm')">Ã—</span>
            <h3 style="margin-bottom:30px; text-align:center; letter-spacing:0.1em; font-weight:400;">ç©¿æ­ç¢ºèª</h3>
            <div id="confirm-visual" class="preview-grid"></div>
            <div class="ai-text">
                <div id="confirm-idea" style="margin-bottom:10px;"></div>
                <div id="confirm-scent" style="font-size:0.85rem; color:var(--primary-color);"></div>
                <div id="confirm-care" class="care-info-box"></div>
            </div>
            <div style="margin-top:30px; display:flex; justify-content:space-between;">
                <button class="btn btn-outline" onclick="closeModal('modal-confirm')">å†çœ‹çœ‹</button>
                <button class="btn btn-primary" onclick="selectTodayOutfit()">ç¢ºèªé¸ç”¨</button>
            </div>
        </div>
    </div>

    <!-- FEEDBACK PAGE (Full Screen Modal) -->
    <div id="modal-feedback" class="modal-fullscreen">
        <div class="mf-header">
            <span class="mf-close" onclick="closeModal('modal-feedback')">Ã—</span>
            <span class="mf-title">TODAY'S FEEDBACK</span>
            <div style="width:24px;"></div>
        </div>
        <div class="mf-body">
            <!-- Read Only -->
            <div class="preview-section">
                <div class="preview-imgs" id="fb-preview-imgs"></div>
                <div class="ai-text" id="fb-preview-style"></div>
            </div>

            <div class="form-group">
                <span class="form-title">ä¸Šå‚³ä»Šæ—¥ç…§ç‰‡ (1-3å¼µ)</span>
                <div class="photo-upload-grid" id="fb-photo-grid">
                    <label class="photo-slot"><span>+</span><input type="file" class="photo-input" accept="image/*" onchange="handlePhotoUpload(this, 0)"><img src="" id="fb-img-0" style="display:none;"></label>
                    <label class="photo-slot"><span>+</span><input type="file" class="photo-input" accept="image/*" onchange="handlePhotoUpload(this, 1)"><img src="" id="fb-img-1" style="display:none;"></label>
                    <label class="photo-slot"><span>+</span><input type="file" class="photo-input" accept="image/*" onchange="handlePhotoUpload(this, 2)"><img src="" id="fb-img-2" style="display:none;"></label>
                </div>
            </div>
            <div class="form-group">
                <span class="form-title">ä»Šæ—¥é«”æ„Ÿ</span>
                <div class="seg-control">
                    <input type="radio" name="fb-thermal" id="th-1" value="å¤ªå†·" class="seg-radio"><label for="th-1" class="seg-label">å¤ªå†·</label>
                    <input type="radio" name="fb-thermal" id="th-2" value="å‰›å¥½" class="seg-radio" checked><label for="th-2" class="seg-label">å‰›å¥½</label>
                    <input type="radio" name="fb-thermal" id="th-3" value="å¤ªç†±" class="seg-radio"><label for="th-3" class="seg-label">å¤ªç†±</label>
                </div>
            </div>
            <div class="form-group">
                <span class="form-title">å–œå¥½ç¨‹åº¦</span>
                <div class="seg-control">
                    <input type="radio" name="fb-like" id="lk-1" value="å–œæ­¡" class="seg-radio" checked><label for="lk-1" class="seg-label">å¾ˆå–œæ­¡</label>
                    <input type="radio" name="fb-like" id="lk-2" value="æ™®é€š" class="seg-radio"><label for="lk-2" class="seg-label">æ™®é€š</label>
                    <input type="radio" name="fb-like" id="lk-3" value="ä¸å–œæ­¡" class="seg-radio"><label for="lk-3" class="seg-label">ä¸å–œæ­¡</label>
                </div>
            </div>
            <div class="form-group">
                <span class="form-title">å¿ƒæƒ…æœ­è¨˜</span>
                <textarea id="fb-note" placeholder="ç°¡å–®è¨˜ä¸‹ä¸€å¤©çš„å¿ƒæƒ…æˆ–ç©¿æ­å¿ƒå¾—..."></textarea>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="saveFeedbackToHistory()">å„²å­˜ä¸¦åŠ å…¥ç´€éŒ„</button>
        </div>
    </div>

    <script>
        /* ==================== 1. è³‡æ–™åº«èˆ‡å¸¸æ•¸ ==================== */
        const TEXTS = {
            'zh-TW': { menu_home: "ä¸»é  Home", menu_ootd: "ä»Šæ—¥ç©¿æ­æ¨è–¦ OOTD", menu_hist: "æ­·å²ç©¿æ­ç´€éŒ„ History", menu_ward: "æˆ‘çš„è¡£æ«¥ Wardrobe", menu_pref: "ç³»çµ±åå¥½è¨­å®š Preferences", btn_ootd: "å‰å¾€ä»Šæ—¥ç©¿æ­æ¨è–¦", btn_ward: "æ•´ç†æˆ‘çš„è¡£æ«¥", title_ootd: "Today's Outfit", title_hist: "History" },
            'en': { menu_home: "Home", menu_ootd: "OOTD Recommendation", menu_hist: "History", menu_ward: "My Wardrobe", menu_pref: "Preferences", btn_ootd: "Get Today's OOTD", btn_ward: "Manage Wardrobe", title_ootd: "Today's Outfit", title_hist: "History" }
        };
        const QUOTES = { sunny: ["ä»Šå¤©é™½å…‰å¾ˆå¥½ï¼Œé©åˆæŠŠå–œæ­¡çš„è‡ªå·±ç©¿å‡ºå»èµ°èµ°ã€‚", "é™½å…‰æŸ”æŸ”çš„ï¼Œé¸ä¸€ä»¶ä½ èˆ’æœçš„è¡£æœå§ã€‚", "ç¾å¥½çš„ä¸€å¤©ï¼Œç”¨èˆ’æœçš„ç©¿æ­é–‹å§‹ã€‚"], cloudy: ["ä»Šå¤©æœ‰é»ç°ï¼Œç©¿å‡ºè‡ªå·±çš„å…‰ã€‚", "ç°è‰²çš„å¤©å¾ˆé©åˆæ¥µç°¡ç©¿æ­ã€‚", "ä»Šå¤©çš„è‰²èª¿æŸ”æŸ”çš„ï¼Œç©¿æ­ä¹Ÿä¸å¿…å¤ªå¼µæšã€‚"], rainy: ["å¤–é¢ä¸‹é›¨ï¼Œè¨˜å¾—å¸¶å¤–å¥—ï¼Œä¹Ÿå¸¶ä¸Šè€å¿ƒã€‚", "é›¨è²å¾ˆè¼•ï¼Œç©¿æ­ä¹Ÿå¯ä»¥ç°¡å–®ä¹¾æ·¨ã€‚", "ä¸‹é›¨å¤©ä¹Ÿèƒ½å¾ˆæ™‚é«¦ï¼Œåªè¦é¸å°å–®å“ã€‚"], cold: ["ä»Šå¤©æœ‰é»å†·ï¼ŒæŠŠè‡ªå·±åŒ…å¾—æš–æš–çš„å¾ˆå¯æ„›ã€‚", "å¤©æ°£å†·ï¼Œå¯ä»¥ç©¿å¾—å±¤æ¬¡æ›´æ¼‚äº®ã€‚", "åšå¤–å¥—ä»Šå¤©æ˜¯ä¸»è§’ã€‚"] };
        const TEMPS = [{ val: "cold", label: "å¯’å†· <12Â°C" }, { val: "cool", label: "æ¶¼çˆ½ 12-20Â°C" }, { val: "warm", label: "å¾®ç†± 20-27Â°C" }, { val: "hot", label: "ç‚ç†± >27Â°C" }];
        const STYLES = ["æ¥µç°¡","ç”œç¾","è‡ªç„¶ç³»","å¹¹ç·´","å…¸é›…","æ°£è³ª","è¡—é ­","æ—¥ç³»","å¾©å¤","Y2K","é‹å‹•"];
        const SCENES = ["ä¸Šç­","ä¸Šèª²","ç´„æœƒ","é‹å‹•","æ—…éŠ","æ­£å¼å ´åˆ","å®¶å±…","æ´¾å°","å’–å•¡å»³","å¤œé–“å¤–å‡º","æ‹ç…§"];
        
        // æœé£¾
        const MAT_CLOTHES = ["æ£‰","éº»","ç¾Šæ¯›","çµ²","èšé…¯","ä¸¹å¯§","çš®é©","çµ¨é¢","é‡ç¹”","é›ªç´¡","å½ˆæ€§çº–ç¶­"];
        const CARE_CLOTHES = ["æ©Ÿæ´—","æ‰‹æ´—","ä¹¾æ´—","é™°ä¹¾","ä¸å¯çƒ˜ä¹¾","ä½æº«ç‡™","å…¶ä»–"];
        const THICKNESS = ["è–„", "é©ä¸­", "åš", "åŠ åš/åˆ·æ¯›"];
        
        // é‹å­ (ä¿®æ­£)
        const SHOE_TYPES = ["çƒé‹","é´å­","é«˜è·Ÿé‹","å¹³åº•/æ¨‚ç¦é‹","æ¶¼é‹","é›¨é‹"];
        const MAT_SHOES = ["çš®é©", "åˆæˆçš®", "éº‚çš®", "å¸†å¸ƒ", "ç¶²å¸ƒ", "æ©¡è† ", "å°ˆåˆ©æè³ª"];
        const CARE_SHOES = ["çš®é‹ä¸Šæ²¹","å¸ƒé‹æ‰‹æ´—","éº‚çš®åˆ·æ‹­","ä¸å¯æµ¸æ³¡","å±€éƒ¨æ¸…æ½”","å…¶ä»–"];
        const SHOE_FUNCS = ["é˜²æ°´", "é˜²æ»‘", "é€æ°£", "å¢é«˜", "è¼•é‡"];
        
        // é£¾å“
        const MAT_ACC = ["é»ƒé‡‘","ç™½éŠ€","ç«ç‘°é‡‘","ä¸é½é‹¼","æ¨¹è„‚","çç ","æ¯›ç·š"];
        const CARE_ACC = ["æ‹­éŠ€å¸ƒ","ä¹¾å¸ƒæ“¦","é¿å…ç¢°æ°´","çš®é©æ²¹","å…¶ä»–"];

        // é¦™æ°›
        const SCENT_DB = {
            "Minimalist": { name: "æ¥µç°¡ Minimalist", family: "æ¸…æ–°æœ¨è³ªèª¿ Fresh Woody", top: "ä½›æ‰‹æŸ‘, è‘¡è„æŸš, ç¶ èŒ¶", mid: "ç™½é›ªæ¾, æª€é¦™, é³¶å°¾èŠ±", base: "éºé¦™, å²©è˜­è‰", desc: "æ¸…äº®ä¹¾æ·¨ã€åƒæ¥µç°¡è¡£æ«¥è£¡çš„ç™½è¥¯è¡«ã€‚" },
            "Sweet": { name: "ç”œç¾ Sweet", family: "èŠ±æœç”œé¦™ Floral Fruity Sweet", top: "è“æœ, æ°´èœœæ¡ƒ, å°è’¼è˜­", mid: "ç«ç‘°, èŒ‰è‰, æ«»èŠ±", base: "é¦™è‰, æ£‰èŠ±ç³–", desc: "å°‘å¥³ç³»é¦™å‘³ï¼Œæº«æŸ”åˆæœ‰æ´»åŠ›ã€‚" },
            "Natural": { name: "è‡ªç„¶ç³» Natural", family: "è‰æœ¬æœ¨è³ªèª¿ Herbal Woody", top: "æŸ‘æ©˜, é’æª¸, ç¾…å‹’", mid: "é¼ å°¾è‰, é›ªæ¾, ç„¡èŠ±æœè‘‰", base: "ç¥ç€, æ°´ç”Ÿèª¿", desc: "åƒåˆå¾Œçš„ç¶ è‰²é¢¨æ™¯ï¼Œä¹¾æ·¨åˆæ”¾é¬†ã€‚" },
            "Sharp": { name: "å¹¹ç·´ Sharp", family: "ä¸­æ€§è¾›é¦™ Woody Spicy", top: "é»‘èƒ¡æ¤’, å°è³è”», æŸ‘æ©˜", mid: "é›ªæ¾, æª€é¦™, å»£è—¿é¦™", base: "ç…™è‰, ç¥ç€, éºé¦™", desc: "ä¹¾æ·¨ä¿è½ã€æœ‰æ±ºæ–·åŠ›çš„é¦™æ°£ã€‚" },
            "Elegant": { name: "å…¸é›… Elegant", family: "ç²‰è³ªèŠ±é¦™ Powdery Floral", top: "æ©™èŠ±, æª¸æª¬çš®", mid: "ç™½ç«ç‘°, ç´«ç¾…è˜­, é³¶å°¾èŠ±", base: "éºé¦™, ç¥ç€", desc: "åƒçµ²è³ªæ´‹è£èˆ¬å„ªé›…æŸ”è»Ÿã€‚" },
            "Graceful": { name: "æ°£è³ªç³» Graceful", family: "ç™½èŠ±é¦™ White Floral", top: "æ¢”å­èŠ±, ä½›æ‰‹æŸ‘", mid: "èŒ‰è‰, éˆ´è˜­, ä¾è˜­", base: "ç™½éºé¦™", desc: "ç™’åˆäººå¿ƒçš„æº«æŸ”é¦™æ°£ã€‚" },
            "Street": { name: "è¡—é ­ç³» Street", family: "ç…™ç‡»æœ¨è³ªèª¿ Smoky Woody", top: "æŸšå­, é¦™æª¸æª¬", mid: "çƒæœ¨, é›ªæ¾, ç„¦ç³–åŒ–æœ¨è³ª", base: "ç¥ç€, éºé¦™", desc: "é…·å¸¥ã€å€‹æ€§ã€ç•¥å¸¶ç¥ç§˜ã€‚" },
            "Japanese": { name: "æ—¥ç³»æ¸…æ–° Japanese", family: "è‚¥çš‚é¦™ Soft Clean", top: "æŸšå­, é’è˜‹æœ", mid: "å±±èŒ¶èŠ±, éˆ´è˜­", base: "ç™½éºé¦™", desc: "ä¹¾æ·¨èˆ’æœã€é›¶è² æ“”çš„æ·¡é¦™ã€‚" },
            "Retro": { name: "å¾©å¤ Retro", family: "æ¨¹è„‚ç¥ç€èª¿ Resin Amber", top: "æ©™èŠ±, ä½›æ‰‹æŸ‘", mid: "è‚‰æ¡‚, å»£è—¿é¦™", base: "ç¥ç€, å®‰æ¯é¦™, é¦™è‰", desc: "æš–æ¿ƒåˆè¿·äººçš„æˆç†Ÿæ°›åœã€‚" },
            "Y2K": { name: "Y2K ç”œè¾£é¢¨", family: "ç”œæœé¦™ï¼‹éºé¦™ Fruity Sexy", top: "è‘¡è„, è˜‹æœ, è‰è“", mid: "ç«ç‘°, èŒ‰è‰èŠ±", base: "éºé¦™, ç¥ç€", desc: "å¯ç”œå¯è¾£ã€å¼µæšè‡ªä¿¡ã€‚" },
            "Sporty": { name: "é‹å‹• Sporty", family: "æ°´ç”Ÿæ¸…çˆ½èª¿ Aqua Fresh", top: "æµ·é¢¨, é’æª¸", mid: "ç¶ èŒ¶, è–„è·", base: "éºé¦™", desc: "æ¸…çˆ½ä¹¾æ·¨ã€åƒå‰›æ´—å®Œæ¾¡çš„å‘³é“ã€‚" }
        };

        /* ==================== 2. STATE & INIT ==================== */
        let state = { user: null, wardrobe: [], history: [], pref: { theme: 'soft-pink', lang: 'zh-TW' }, todayOutfit: null };
        let currentOOTD = null;
        let tempUserImgs = [null, null, null]; 
        let tempTheme = 'soft-pink';
        let editingItemId = null; // For Edit Mode

        function init() {
            const data = localStorage.getItem('sartorial_db_v3');
            if (data) {
                state = JSON.parse(data);
                if (!state.pref.theme) state.pref.theme = 'soft-pink';
                tempTheme = state.pref.theme;
                applyTheme(state.pref.theme); applyLang(state.pref.lang);
                if(!state.user) showIntro(); else renderHome();
            } else { showIntro(); }
            const today = new Date().toLocaleDateString(state.pref.lang === 'en' ? 'en-US' : 'zh-TW');
            document.getElementById('home-date-display').innerText = today;
            document.getElementById('drawer-date').innerText = today;
            updateWeatherAnim();
        }

        function showIntro() { document.getElementById('intro-overlay').style.display = 'flex'; }
        function initUser() {
            const name = document.getElementById('username-input').value;
            if(!name) return;
            state.user = name; saveData();
            document.getElementById('intro-overlay').style.display = 'none';
            renderHome();
        }
        function saveData() { localStorage.setItem('sartorial_db_v3', JSON.stringify(state)); }
        
        function previewTheme(themeName, el) { tempTheme = themeName; applyTheme(themeName); document.querySelectorAll('.theme-swatch').forEach(d=>d.classList.remove('active')); if(el) el.classList.add('active'); }
        function applyTheme(theme) { document.documentElement.setAttribute('data-theme', theme); }
        function setLanguage(lang) { applyLang(lang); }
        function applyLang(lang) { const t = TEXTS[lang]; if(!t) return; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if(t[key]) el.innerText = t[key]; }); document.getElementById('pref-lang').value = lang; }

        function renderPref() {
            document.getElementById('pref-name').value = state.user; document.getElementById('pref-lang').value = state.pref.lang;
            document.querySelectorAll('.theme-swatch').forEach(sw => { sw.classList.remove('active'); if(sw.getAttribute('onclick').includes(state.pref.theme)) sw.classList.add('active'); });
        }
        function savePref() { state.user = document.getElementById('pref-name').value; state.pref.lang = document.getElementById('pref-lang').value; state.pref.theme = tempTheme; saveData(); applyLang(state.pref.lang); alert("è¨­å®šå·²å„²å­˜ï¼"); }
        function clearData() { if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™ï¼ˆå«è¡£æ«¥èˆ‡æ­·å²ç´€éŒ„ï¼‰å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) { localStorage.removeItem('sartorial_db_v3'); location.reload(); } }

        /* ==================== 3. HOME & NAVIGATION ==================== */
        function renderHome() {
            document.getElementById('home-greeting').innerText = `Hi, ${state.user}`;
            updateWeatherAnim();
            renderTodaySection();
        }

        // ğŸ”§ Render Today's Look (New Logic)
        function renderTodaySection() {
            const card = document.getElementById('home-today-card');
            const thumbContainer = document.getElementById('today-thumbnails');
            const dateEl = document.getElementById('today-date-sm');
            const weatherEl = document.getElementById('today-weather-sm');
            const styleEl = document.getElementById('today-meta-style');
            const scentEl = document.getElementById('today-meta-scent');
            const careEl = document.getElementById('today-care-block');

            if (state.todayOutfit) {
                card.style.display = 'block';
                dateEl.innerText = state.todayOutfit.date;
                weatherEl.innerText = state.todayOutfit.weather;
                thumbContainer.innerHTML = state.todayOutfit.items.map(i => `<img src="${i.img || ''}" class="today-thumb" title="${i.name}">`).join('');
                styleEl.innerText = state.todayOutfit.style || '--';
                scentEl.innerText = state.todayOutfit.scent ? state.todayOutfit.scent.name : '--';
                careEl.innerHTML = state.todayOutfit.careText || '';
            } else {
                card.style.display = 'none';
            }
        }

        function updateWeatherAnim() {
            const temp = parseInt(document.getElementById('ootd-temp').value) || 24;
            const isRain = document.getElementById('ootd-rain').checked;
            const display = document.getElementById('home-weather-display');
            const drawerW = document.getElementById('drawer-weather');
            const animLayer = document.getElementById('weather-anim-layer');
            const iconEl = document.getElementById('weather-icon-el');
            const noteText = document.getElementById('home-daily-note');
            
            let weatherType = 'sunny', weatherText = 'æ™´', iconClass = 'icon-sunny';
            if(isRain) { weatherType = 'rainy'; weatherText = 'é›¨'; iconClass = 'icon-rainy-light'; } 
            else if(temp < 20) { weatherType = 'cloudy'; weatherText = 'é™°/æ¶¼'; iconClass = 'icon-cloudy'; }
            const str = `${weatherText} ${temp}Â°C`;
            display.innerText = str; drawerW.innerText = str;
            animLayer.className = 'weather-animation ' + weatherType; iconEl.className = 'weather-icon ' + iconClass;
            
            let category = 'sunny'; if(isRain) category = 'rainy'; else if(temp < 15) category = 'cold'; else if(temp < 22) category = 'cloudy';
            const list = QUOTES[category]; noteText.innerText = list[Math.floor(Math.random() * list.length)];
        }

        function toggleDrawer() { document.getElementById('drawer').classList.toggle('open'); document.getElementById('drawer-overlay').classList.toggle('open'); }
        function navTo(id) {
            toggleDrawer(); document.querySelectorAll('.section').forEach(el=>el.classList.remove('active'));
            document.getElementById('section-'+id).classList.add('active');
            if(id==='home') renderHome();
            if(id==='wardrobe') renderWardrobe();
            if(id==='history') renderHistory();
            if(id==='ootd') initOOTDForm();
            if(id==='pref') renderPref();
        }

        /* ==================== 4. WARDROBE & ADD/EDIT ==================== */
        let addStep = 1;
        function openAddModal() { 
            editingItemId = null; // Reset edit mode
            document.getElementById('modal-add').classList.add('open'); 
            resetAddForm(); 
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        function renderTags(containerId, dataArray) {
            const container = document.getElementById(containerId); if(!container) return;
            container.innerHTML = dataArray.map(item => `<span class="tag-pill" onclick="toggleTag(this)">${item}</span>`).join('');
        }
        function toggleTag(el) { el.classList.toggle('active'); }
        function getActiveTags(containerId) {
            const container = document.getElementById(containerId); if(!container) return [];
            return Array.from(container.querySelectorAll('.tag-pill.active')).map(el => el.innerText);
        }
        // ğŸ”§ Helper to set active tags for Edit Mode
        function setActiveTags(containerId, activeValues) {
            if(!activeValues) return;
            const container = document.getElementById(containerId); if(!container) return;
            container.querySelectorAll('.tag-pill').forEach(pill => {
                if(activeValues.includes(pill.innerText)) pill.classList.add('active');
            });
        }

        function resetAddForm() {
            addStep = 1; updateStepView(); document.getElementById('add-form').reset();
            document.getElementById('inp-img-base64').value = ""; 
            renderTags('tags-temp', TEMPS.map(t=>t.label)); renderTags('tags-thickness', THICKNESS); renderTags('tags-style', STYLES);
            renderTags('tags-scene', SCENES); renderTags('tags-shoe-func', SHOE_FUNCS); renderTags('tags-material', MAT_CLOTHES); renderTags('tags-care', CARE_CLOTHES);
            updateStep2View(); 
        }

        function goStep(n) { addStep = n; updateStepView(); }
        function updateStepView() {
            for(let i=1;i<=4;i++) document.getElementById(`dot-${i}`).classList.toggle('active', i===addStep);
            document.querySelectorAll('.step-view').forEach(v=>v.classList.remove('active')); document.getElementById(`step-${addStep}`).classList.add('active');
        }

        function updateStep2View() {
            const cat = document.getElementById('inp-category').value;
            document.getElementById('view-clothes').classList.add('hidden'); document.getElementById('view-shoes').classList.add('hidden'); document.getElementById('view-acc').classList.add('hidden');
            const matContainerId = 'tags-material'; const careContainerId = 'tags-care';
            
            // ğŸ”§ Shoe & Acc logic separation
            if (cat === 'shoes') { 
                document.getElementById('view-shoes').classList.remove('hidden'); 
                renderTags(matContainerId, MAT_SHOES); renderTags(careContainerId, CARE_SHOES); 
            } else if (cat === 'acc') { 
                document.getElementById('view-acc').classList.remove('hidden'); 
                renderTags(matContainerId, MAT_ACC); renderTags(careContainerId, CARE_ACC); 
            } else { 
                document.getElementById('view-clothes').classList.remove('hidden'); 
                renderTags(matContainerId, MAT_CLOTHES); renderTags(careContainerId, CARE_CLOTHES); 
            }
        }

        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader(); reader.onload = function(e) { document.getElementById('inp-img-base64').value = e.target.result; }; reader.readAsDataURL(input.files[0]);
            }
        }

        // ğŸ”§ Save Item (Handles both New and Edit)
        function saveItem() {
            const cat = document.getElementById('inp-category').value;
            const imgVal = document.getElementById('inp-img-base64').value; 
            
            let item = {
                id: editingItemId ? editingItemId : Date.now(), // Preserve ID if editing
                name: document.getElementById('inp-name').value||'æœªå‘½åå–®å“', category: cat, 
                // Keep old image if editing and no new one uploaded
                img: (editingItemId && imgVal === "") ? state.wardrobe.find(i=>i.id===editingItemId).img : imgVal,
                color: document.getElementById('inp-color').value, 
                material: getActiveTags('tags-material'), styles: getActiveTags('tags-style'),
                scenes: getActiveTags('tags-scene'), care: getActiveTags('tags-care'),
                extra: {} // Initialize extra for shoes/acc
            };

            if (cat === 'shoes') { 
                item.shoeType = document.getElementById('inp-shoe-type').value; 
                item.shoeGrip = document.getElementById('inp-shoe-grip').value; 
                // Save waterproof status into extra for OOTD logic
                const funcs = getActiveTags('tags-shoe-func');
                item.functions = funcs;
                item.extra.waterproof = funcs.includes('é˜²æ°´');
            } else if (cat === 'acc') { 
                item.accType = document.getElementById('inp-acc-type').value; 
                item.accPart = document.getElementById('inp-acc-part').value; 
                item.extra.wearPart = item.accPart; // Alias for safer access
            } else { 
                const activeTempLabels = getActiveTags('tags-temp'); 
                item.temps = activeTempLabels.map(label => { if(label.includes('å¯’å†·')) return 'cold'; if(label.includes('æ¶¼çˆ½')) return 'cool'; if(label.includes('å¾®ç†±')) return 'warm'; return 'hot'; });
                item.thickness = getActiveTags('tags-thickness').join(', ');
            }

            if (editingItemId) {
                // Update existing
                const idx = state.wardrobe.findIndex(i => i.id === editingItemId);
                if(idx !== -1) state.wardrobe[idx] = item;
            } else {
                // Add new
                state.wardrobe.push(item);
            }
            
            saveData(); closeModal('modal-add'); 
            
            // If we were in detail view, refresh it or close it
            if(editingItemId) { closeModal('modal-item-detail'); openItemDetail(editingItemId); }
            else { renderWardrobe(); }
        }

        function renderWardrobe(filter='all') {
            const grid = document.getElementById('wardrobe-grid'); grid.innerHTML = '';
            const items = filter==='all' ? state.wardrobe : state.wardrobe.filter(i=>i.category===filter);
            if(items.length === 0) { grid.innerHTML='<div style="grid-column:1/-1;text-align:center;color:#999;margin-top:20px;">å°šç„¡å–®å“</div>'; return; }
            items.forEach(i => {
                const matDisplay = Array.isArray(i.material) ? i.material.join('/') : i.material;
                // Add click event to open detail
                grid.innerHTML += `
                    <div class="w-item" onclick="openItemDetail(${i.id})">
                        <img src="${i.img||''}" class="w-img" loading="lazy">
                        <div class="w-info"><div class="w-name">${i.name}</div><div class="w-tag">${i.category} | ${matDisplay || ''}</div></div>
                    </div>`;
            });
        }
        function filterWardrobe(c, b) { document.querySelectorAll('.filter-btn').forEach(el=>el.classList.remove('active')); b.classList.add('active'); renderWardrobe(c); }

        // ğŸ”§ NEW: Item Detail Logic
        function openItemDetail(id) {
            const item = state.wardrobe.find(i => i.id === id);
            if (!item) return;

            // Find history dates
            const usedDates = state.history.filter(h => h.items.some(hi => hi.id === id)).map(h => h.date);
            const historyHtml = usedDates.length > 0 ? usedDates.join(', ') : 'å°šæœªç©¿é';

            // Generate Attribute Rows based on Category
            let attrHtml = '';
            const matStr = Array.isArray(item.material) ? item.material.join(', ') : item.material;
            const careStr = Array.isArray(item.care) ? item.care.join(', ') : item.care;
            const styleStr = Array.isArray(item.styles) ? item.styles.map(s=>`<span class="detail-tag-sm">${s}</span>`).join('') : '';
            const sceneStr = Array.isArray(item.scenes) ? item.scenes.map(s=>`<span class="detail-tag-sm">${s}</span>`).join('') : '';

            attrHtml += `<div class="detail-row"><span class="detail-label">é¡åˆ¥</span><span class="detail-val">${item.category}</span></div>`;
            attrHtml += `<div class="detail-row"><span class="detail-label">æè³ª</span><span class="detail-val">${matStr}</span></div>`;
            
            if (item.category === 'shoes') {
                attrHtml += `<div class="detail-row"><span class="detail-label">é‹æ¬¾</span><span class="detail-val">${item.shoeType || '--'}</span></div>`;
                const funcStr = item.functions ? item.functions.join(', ') : '';
                attrHtml += `<div class="detail-row"><span class="detail-label">åŠŸèƒ½</span><span class="detail-val">${funcStr}</span></div>`;
                attrHtml += `<div class="detail-row"><span class="detail-label">é˜²æ»‘</span><span class="detail-val">${item.shoeGrip || '--'}</span></div>`;
            } else if (item.category === 'acc') {
                 attrHtml += `<div class="detail-row"><span class="detail-label">é¡å‹</span><span class="detail-val">${item.accType || '--'}</span></div>`;
            } else {
                // Clothes
                const tempStr = item.temps ? item.temps.join(', ') : ''; // Simplify temp codes for display
                attrHtml += `<div class="detail-row"><span class="detail-label">é©åˆæ°£æº«</span><span class="detail-val">${tempStr}</span></div>`;
                attrHtml += `<div class="detail-row"><span class="detail-label">åšåº¦</span><span class="detail-val">${item.thickness || '--'}</span></div>`;
            }

            attrHtml += `<div class="detail-row"><span class="detail-label">é¡è‰²</span><span class="detail-val">${item.color || '--'}</span></div>`;
            attrHtml += `<div class="detail-row"><span class="detail-label">æ´—æ»Œ</span><span class="detail-val">${careStr}</span></div>`;
            attrHtml += `<div class="detail-row"><span class="detail-label">é¢¨æ ¼</span><div class="detail-tags">${styleStr}</div></div>`;
            attrHtml += `<div class="detail-row"><span class="detail-label">å ´æ™¯</span><div class="detail-tags">${sceneStr}</div></div>`;
            attrHtml += `<div class="detail-row"><span class="detail-label">ç©¿æ­å±¥æ­·</span><span class="detail-val" style="font-size:0.8rem; line-height:1.4">${historyHtml}</span></div>`;

            const html = `
                <div class="detail-grid">
                    <div class="detail-img-box"><img src="${item.img}"></div>
                    <h3 style="margin:0; text-align:center;">${item.name}</h3>
                    <div class="detail-attrs">${attrHtml}</div>
                    <div class="detail-actions">
                        <button class="btn btn-outline" style="flex:1" onclick="editItem(${item.id})">ç·¨è¼¯</button>
                        <button class="btn btn-danger" style="flex:1" onclick="deleteItem(${item.id})">ä¸Ÿæ£„</button>
                    </div>
                </div>
            `;
            document.getElementById('item-detail-content').innerHTML = html;
            document.getElementById('modal-item-detail').classList.add('open');
        }

        // ğŸ”§ Edit Item Logic
        function editItem(id) {
            const item = state.wardrobe.find(i => i.id === id);
            if(!item) return;
            
            editingItemId = id;
            closeModal('modal-item-detail');
            document.getElementById('modal-add').classList.add('open');
            
            // Populate Form
            document.getElementById('inp-name').value = item.name;
            document.getElementById('inp-category').value = item.category;
            document.getElementById('inp-color').value = item.color;
            // Image (Base64) is handled in save logic if not changed, but we can't set file input
            
            // Trigger View Update for Tags
            resetAddForm(); // Initialize tags first
            updateStep2View(); // Ensure correct specific view is shown
            
            // Pre-select Category (again after reset)
            document.getElementById('inp-category').value = item.category;
            updateStep2View();

            // Set Tags Active
            setActiveTags('tags-style', item.styles);
            setActiveTags('tags-scene', item.scenes);
            setActiveTags('tags-care', item.care);
            setActiveTags('tags-material', item.material);

            if (item.category === 'shoes') {
                document.getElementById('inp-shoe-type').value = item.shoeType;
                document.getElementById('inp-shoe-grip').value = item.shoeGrip;
                setActiveTags('tags-shoe-func', item.functions);
            } else if (item.category === 'acc') {
                document.getElementById('inp-acc-type').value = item.accType;
                document.getElementById('inp-acc-part').value = item.accPart;
            } else {
                setActiveTags('tags-thickness', [item.thickness]); 
            }
        }

        function deleteItem(id) {
            if(confirm("ç¢ºå®šè¦ä¸Ÿæ£„æ­¤å–®å“å—ï¼Ÿ(æ­·å²ç´€éŒ„ä»æœƒä¿ç•™)")) {
                state.wardrobe = state.wardrobe.filter(item => item.id !== id);
                saveData();
                closeModal('modal-item-detail');
                renderWardrobe();
            }
        }

        /* ==================== 5. OOTD & SCENT LOGIC (Refined) ==================== */
        function initOOTDForm() { renderTags('ootd-scenes', SCENES); renderTags('ootd-styles', STYLES); }

        function generateOOTD() {
            const temp = parseInt(document.getElementById('ootd-temp').value);
            const rain = document.getElementById('ootd-rain').checked;
            const userStyles = getActiveTags('ootd-styles'); 

            let tTag = 'warm'; 
            if(temp < 12) tTag = 'cold'; 
            else if(temp <= 20) tTag = 'cool'; 
            else if(temp <= 27) tTag = 'warm'; 
            else tTag = 'hot';
            
            // Helper: Score Item
            const scoreItem = (item) => {
                let score = Math.random() * 10;
                // Style match bonus
                if (item.styles && item.styles.some(s => userStyles.includes(s))) score += 50;
                
                // Weather Thickness Logic
                if (item.category !== 'shoes' && item.category !== 'acc' && item.category !== 'outer') {
                    if (tTag === 'cold' && item.thickness && item.thickness.includes('åš')) score += 20;
                    if (tTag === 'hot' && item.thickness && item.thickness.includes('è–„')) score += 20;
                }

                // Shoe Specifics
                if (item.category === 'shoes') {
                    // Rain: Prioritize waterproof
                    if (rain) {
                        const isWaterproof = item.extra?.waterproof || (item.functions && item.functions.includes('é˜²æ°´'));
                        if (isWaterproof) score += 100; 
                    }
                    // Temp based shoe preference
                    if (tTag === 'cold' && item.shoeType === 'boots') score += 15;
                    if (tTag === 'hot' && (item.shoeType === 'sandals' || item.functions?.includes('é€æ°£'))) score += 15;
                }

                return score;
            };

            // Filter Helpers
            const getFilteredPool = (cat) => {
                return state.wardrobe.filter(i => {
                    // Basic Category
                    if (i.category !== cat) return false;
                    // Temp Match (skip for acc/shoes generally, but keep logic simple)
                    if (i.category !== 'shoes' && i.category !== 'acc') {
                        if (i.temps && i.temps.length > 0 && !i.temps.includes(tTag)) return false; 
                    }
                    return true;
                }).sort((a, b) => scoreItem(b) - scoreItem(a));
            };

            const tops = getFilteredPool('top');
            const bottoms = getFilteredPool('bottom');
            const onepieces = getFilteredPool('onepiece');
            const outers = getFilteredPool('outer');
            const shoes = getFilteredPool('shoes');
            const accs = getFilteredPool('acc');

            const resDiv = document.getElementById('ootd-results'); resDiv.innerHTML='';

            // Generate 3 Options
            for(let i=0;i<3;i++) {
                let outfit = [];
                
                // --- 1. Base Outfit (Dress OR Top+Bottom) ---
                const useDress = (onepieces.length > 0 && Math.random() > 0.5) || (tops.length === 0 || bottoms.length === 0);
                
                if (useDress && onepieces.length > 0) {
                    outfit.push(onepieces[0]);
                    // Rotate
                    if(onepieces.length > 3) onepieces.push(onepieces.shift());
                } else if (tops.length > 0 && bottoms.length > 0) {
                    outfit.push(tops[0]);
                    outfit.push(bottoms[0]);
                    // Rotate
                    if(tops.length > 3) tops.push(tops.shift());
                    if(bottoms.length > 3) bottoms.push(bottoms.shift());
                } else {
                    // Not enough clothes
                    continue; 
                }

                // --- 2. Outer Logic ---
                // < 20: Suggest Outer. > 25: No Outer. 20-25: Random.
                let needOuter = false;
                if (temp < 20) needOuter = true;
                else if (temp >= 20 && temp <= 25) needOuter = (Math.random() > 0.5);
                
                if (needOuter && outers.length > 0) {
                    outfit.unshift(outers[0]);
                    if(outers.length > 3) outers.push(outers.shift());
                }

                // --- 3. Shoes ---
                if (shoes.length > 0) {
                    outfit.push(shoes[0]);
                    if(shoes.length > 3) shoes.push(shoes.shift());
                }

                // --- 4. Accessories ---
                // Ensure unique body parts
                const usedParts = new Set();
                accs.forEach(acc => {
                    const part = acc.extra?.wearPart || acc.accPart;
                    if (outfit.length < 6 && !usedParts.has(part)) { // Cap at reasonable number
                        outfit.push(acc);
                        usedParts.add(part);
                    }
                });

                // --- 5. Final Calculation ---
                const mainStyle = calculateMainStyle(outfit, userStyles);
                const scentProfile = getScentProfile(mainStyle);
                const careText = formatCareInstructions(outfit);
                
                const card = document.createElement('div'); card.className = 'card ootd-result-card outfit-card';
                card.innerHTML = `
                    <div class="ootd-header"><span style="font-weight:500;">çµ„åˆ ${i+1}</span><span style="font-size:0.8rem; color:#999;">${mainStyle}</span></div>
                    <div class="ootd-display">${outfit.map(x=>`<div class="ootd-piece"><img src="${x.img||''}"><br><span>${x.name}</span></div>`).join('')}</div>
                    <p style="font-size:0.9rem; color:#555;">é©åˆ ${tTag} çš„å¤©æ°£ã€‚${shoes.length===0?'<br><small style="color:red;">*ç¼ºé‹å­</small>':''}</p>
                    <div class="scent-box">ğŸŒ¿ ${scentProfile.name}</div>
                    <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick='openConfirmModal(${JSON.stringify(outfit)}, "${mainStyle}", ${JSON.stringify(scentProfile)}, "${careText}")'>é¸æ“‡é€™å¥—</button>
                `;
                resDiv.appendChild(card);
            }
            if(resDiv.innerHTML==='') resDiv.innerHTML='<p style="text-align:center;color:#999">è¡£ç‰©ä¸è¶³ä»¥æ­é…</p>';
        }

        // ğŸ”§ Helper: Calculate Care Text (Smart Integration)
        function formatCareInstructions(items) {
            let careList = items.map(i => {
                const c = Array.isArray(i.care) ? i.care.join('/') : (i.care || 'æœªçŸ¥');
                return { cat: i.category, text: c };
            });
            // Check uniqueness
            const distinctCares = [...new Set(careList.map(c => c.text))];
            
            if (distinctCares.length === 1 && distinctCares[0] !== 'æœªçŸ¥') {
                return `å…¨å¥—å»ºè­°æ´—æ»Œæ–¹å¼ï¼š${distinctCares[0]}`;
            }
            
            // Map category to nice name
            const catMap = { 'top': 'ä¸Šè¡£', 'bottom': 'ä¸‹è£', 'onepiece': 'æ´‹è£', 'outer': 'å¤–å¥—', 'shoes': 'é‹å­', 'acc': 'é£¾å“' };
            return careList.map(c => `ãƒ»${catMap[c.cat] || c.cat}: ${c.text}`).join('<br>');
        }

        // ğŸ”§ Helper: Calculate Main Style (Prioritize User Selection)
        function calculateMainStyle(outfitItems, userSelectedStyles) {
            let styleCounts = {};
            let hasUserStyle = false;

            outfitItems.forEach(item => {
                if(item.styles) {
                    item.styles.forEach(s => {
                        styleCounts[s] = (styleCounts[s] || 0) + 1;
                        if(userSelectedStyles.includes(s)) {
                            styleCounts[s] += 10; // Massive weight to user selection
                            hasUserStyle = true;
                        }
                    });
                }
            });

            let bestStyle = "æ¥µç°¡"; 
            let maxCount = -1;
            for (const [style, count] of Object.entries(styleCounts)) {
                if (count > maxCount) { maxCount = count; bestStyle = style; }
            }
            return bestStyle;
        }

        function getScentProfile(style) {
            if(style.includes("æ¥µç°¡")) return SCENT_DB["Minimalist"];
            if(style.includes("ç”œç¾")) return SCENT_DB["Sweet"];
            if(style.includes("è‡ªç„¶")) return SCENT_DB["Natural"];
            if(style.includes("å¹¹ç·´")) return SCENT_DB["Sharp"];
            if(style.includes("å…¸é›…")) return SCENT_DB["Elegant"];
            if(style.includes("æ°£è³ª")) return SCENT_DB["Graceful"];
            if(style.includes("è¡—é ­") || style.includes("æš—é»‘") || style.includes("ä¸­æ€§")) return SCENT_DB["Street"];
            if(style.includes("æ—¥ç³»")) return SCENT_DB["Japanese"];
            if(style.includes("å¾©å¤")) return SCENT_DB["Retro"];
            if(style.includes("Y2K")) return SCENT_DB["Y2K"];
            if(style.includes("é‹å‹•")) return SCENT_DB["Sporty"];
            return SCENT_DB["Minimalist"]; 
        }

        /* ==================== 6. CONFIRM & FEEDBACK FLOW ==================== */
        
        function openConfirmModal(outfit, style, scentProfile, careText) {
            currentOOTD = { items: outfit, style: style, scent: scentProfile, careText: careText };
            document.getElementById('modal-confirm').classList.add('open');
            document.getElementById('confirm-visual').innerHTML = outfit.map(x=>`<div class="preview-item"><img src="${x.img||''}"><br><span>${x.name}</span></div>`).join('');
            document.getElementById('confirm-idea').innerText = `é€™å¥—æ­é…ä¸»æ‰“ ${style} é¢¨æ ¼ï¼Œé©åˆä»Šæ—¥å¤©æ°£ã€‚`;
            document.getElementById('confirm-scent').innerHTML = `æ¨è–¦é¦™æ°›ï¼š<b>${scentProfile.name}</b><br><span style='font-size:0.8rem;color:#777'>${scentProfile.desc}</span>`;
            document.getElementById('confirm-care').innerHTML = careText;
        }

        function selectTodayOutfit() {
            state.todayOutfit = {
                date: new Date().toLocaleDateString(),
                weather: document.getElementById('home-weather-display').innerText,
                items: currentOOTD.items,
                style: currentOOTD.style,
                scent: currentOOTD.scent,
                careText: currentOOTD.careText
            };
            saveData();
            closeModal('modal-confirm');
            navTo('home'); 
        }

        function openFeedbackPage() {
            const today = state.todayOutfit;
            if(!today) return;
            const prevImgs = document.getElementById('fb-preview-imgs');
            prevImgs.innerHTML = today.items.map(i => `<img src="${i.img||''}" class="preview-img-lg">`).join('');
            document.getElementById('fb-preview-style').innerText = `ä»Šæ—¥é¢¨æ ¼ï¼š${today.style || 'æ—¥å¸¸'}`;
            
            document.getElementById('fb-note').value = "";
            tempUserImgs = [null, null, null];
            for(let i=0; i<3; i++) {
                document.getElementById(`fb-img-${i}`).src = "";
                document.getElementById(`fb-img-${i}`).style.display = 'none';
                document.querySelectorAll('.photo-input')[i].value = "";
            }
            document.getElementById('modal-feedback').classList.add('open');
        }

        function handlePhotoUpload(input, index) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    tempUserImgs[index] = evt.target.result;
                    const imgEl = document.getElementById(`fb-img-${index}`);
                    imgEl.src = evt.target.result; imgEl.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveFeedbackToHistory() {
            if (!state.todayOutfit) return;
            const validImgs = tempUserImgs.filter(x => x !== null);
            const rec = {
                id: Date.now(),
                date: state.todayOutfit.date, weather: state.todayOutfit.weather,
                items: state.todayOutfit.items, style: state.todayOutfit.style, scent: state.todayOutfit.scent,
                note: document.getElementById('fb-note').value, userImgs: validImgs, 
                thermal: document.querySelector('input[name="fb-thermal"]:checked').value,
                like: document.querySelector('input[name="fb-like"]:checked').value
            };
            state.history.unshift(rec);
            state.todayOutfit = null; 
            saveData();
            closeModal('modal-feedback');
            navTo('history');
        }

        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML='';
            if(state.history.length===0) { list.innerHTML='<p style="text-align:center;color:#999">ç„¡ç´€éŒ„</p>'; return; }
            state.history.forEach(h => {
                let userPhotosHtml = '';
                if (h.userImgs && Array.isArray(h.userImgs)) { userPhotosHtml = h.userImgs.map(src => `<img src="${src}" class="h-user-photo" title="ç©¿æ­å¯¦æ‹">`).join(''); } 
                else if (h.userImg) { userPhotosHtml = `<img src="${h.userImg}" class="h-user-photo">`; }
                const scentHtml = h.scent ? `<div class="h-scent-tag">ğŸŒ¿ ${h.scent.name}</div>` : '';
                list.innerHTML += `
                    <div class="h-item">
                        <div style="text-align:right;">
                            <div class="h-date">${h.date}</div>
                            <div class="h-weather">${h.weather}</div>
                        </div>
                        <div>
                            <div class="h-imgs">${userPhotosHtml}${h.items.map(i=>`<img src="${i.img||''}">`).join('')}</div>
                            ${scentHtml}
                            <div class="h-note">${h.note||'ç„¡æœ­è¨˜'}</div>
                            <div class="h-tags"><span>${h.thermal}</span> <span>${h.like}</span></div>
                        </div>
                    </div>`;
            });
        }

        window.onload = init;

    </script>
</body>
</html>
